
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Usage Tips &#8212; pytest_container  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Changelog" href="changelog.html" />
    <link rel="prev" title="Fixtures" href="fixtures.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="usage-tips">
<h1>Usage Tips<a class="headerlink" href="#usage-tips" title="Permalink to this heading">¶</a></h1>
<section id="adding-global-build-run-or-pod-create-arguments">
<h2>Adding global build, run or pod create arguments<a class="headerlink" href="#adding-global-build-run-or-pod-create-arguments" title="Permalink to this heading">¶</a></h2>
<p>Sometimes it is necessary to customize the build, run or pod create parameters
of the container runtime globally, e.g. to use the host’s network with docker
via <code class="docutils literal notranslate"><span class="pre">--network=host</span></code>.</p>
<p>The <a class="reference internal" href="api.html#pytest_container.container.ContainerBaseABC.prepare_container" title="pytest_container.container.ContainerBaseABC.prepare_container"><code class="xref py py-meth docutils literal notranslate"><span class="pre">prepare_container()</span></code></a>
and <a class="reference internal" href="api.html#pytest_container.container.ContainerBase.get_launch_cmd" title="pytest_container.container.ContainerBase.get_launch_cmd"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_launch_cmd()</span></code></a> methods
support passing such additional arguments/flags, but this is rather cumbersome
to use in practice. The <code class="docutils literal notranslate"><span class="pre">*container*</span></code> and <code class="docutils literal notranslate"><span class="pre">pod*</span></code> fixtures will therefore
automatically collect such additional arguments from the CLI that were passed
alongside the invocation of <strong class="command">pytest</strong> via the flags
<code class="docutils literal notranslate"><span class="pre">--extra-run-args</span></code>, <code class="docutils literal notranslate"><span class="pre">--extra-build-args</span></code> and
<code class="docutils literal notranslate"><span class="pre">--extra-pod-create-args</span></code>. This requires that you call the function
<a class="reference internal" href="api.html#pytest_container.helpers.add_extra_run_and_build_args_options" title="pytest_container.helpers.add_extra_run_and_build_args_options"><code class="xref py py-func docutils literal notranslate"><span class="pre">add_extra_run_and_build_args_options()</span></code></a> in the
<code class="docutils literal notranslate"><span class="pre">pytest_addoption</span></code> function in your <code class="file docutils literal notranslate"><span class="pre">conftest.py</span></code> as follows:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">conftest.py</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytest_container</span> <span class="kn">import</span> <span class="n">add_extra_run_and_build_args_options</span>


<span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">add_extra_run_and_build_args_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then pass any extra arguments to your pytest invocation as follows:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pytest<span class="w"> </span>--extra-build-args<span class="o">=</span><span class="s2">&quot;--network=host&quot;</span><span class="w"> </span>--extra-build-args<span class="o">=</span><span class="s2">&quot;--no-cache&quot;</span>
</pre></div>
</div>
<p>Note that multiple arguments have to be passed individually as shown in the
example above.</p>
<p><strong>Caution:</strong> The <a class="reference internal" href="api.html#pytest_container.build.MultiStageBuild" title="pytest_container.build.MultiStageBuild"><code class="xref py py-class docutils literal notranslate"><span class="pre">MultiStageBuild</span></code></a> class also
supports additional build flags, but these are <strong>not</strong> collected
automatically. If you wish to use these, you have to inject them manually as
follows:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">test_multistage.py</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytest_container</span> <span class="kn">import</span> <span class="n">get_extra_build_args</span>

<span class="kn">from</span> <span class="nn">test_data</span> <span class="kn">import</span> <span class="n">MULTI_STAGE_BUILD</span>


<span class="k">def</span> <span class="nf">test_multistage_build</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="n">pytestconfig</span><span class="p">,</span> <span class="n">container_runtime</span><span class="p">):</span>
    <span class="n">MULTI_STAGE_BUILD</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
        <span class="n">tmp_path</span><span class="p">,</span>
        <span class="n">pytestconfig</span><span class="p">,</span>
        <span class="n">container_runtime</span><span class="p">,</span>
        <span class="c1"># the flags are added here:</span>
        <span class="n">extra_build_args</span><span class="o">=</span><span class="n">get_extra_build_args</span><span class="p">(</span><span class="n">pytestconfig</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="configuring-logging">
<h2>Configuring logging<a class="headerlink" href="#configuring-logging" title="Permalink to this heading">¶</a></h2>
<p>The plugin uses python’s internal logging module to log debugging messages. You
can set the logging level in your own module by calling the function
<a class="reference internal" href="api.html#pytest_container.logging.set_internal_logging_level" title="pytest_container.logging.set_internal_logging_level"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_internal_logging_level()</span></code></a>. This needs to
happen before any tests are run, preferably in a pytest hook,
e.g. <a class="reference external" href="https://docs.pytest.org/en/latest/reference/reference.html#_pytest.hookspec.pytest_configure">pytest_configure</a>.</p>
<p>Sometimes it makes sense to allow the end users to configure the logging
level. You can accomplish this via the
<a class="reference internal" href="api.html#pytest_container.helpers.add_logging_level_options" title="pytest_container.helpers.add_logging_level_options"><code class="xref py py-func docutils literal notranslate"><span class="pre">add_logging_level_options()</span></code></a> function, which
adds an option to the pytest CLI flags. To actually implement this setting, call
<a class="reference internal" href="api.html#pytest_container.helpers.set_logging_level_from_cli_args" title="pytest_container.helpers.set_logging_level_from_cli_args"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_logging_level_from_cli_args()</span></code></a> in a hook
function of your choice in <code class="file docutils literal notranslate"><span class="pre">conftest.py</span></code>, e.g. as follows:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">conftest.py</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">add_logging_level_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">set_logging_level_from_cli_args</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="testing-local-images">
<h2>Testing local images<a class="headerlink" href="#testing-local-images" title="Permalink to this heading">¶</a></h2>
<p>Sometimes it is necessary to run your tests against a locally build image
instead of a remote one. For such a case, you can use the following
syntax for the Container’s url, which is inspired by skopeo’s syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;containers-storage:my/local/image/name&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A Container defined in this way can be used like any other Container
instance.</p>
</section>
<section id="controlling-the-image-pulling-behavior">
<span id="controlling-image-pulling-behavior"></span><h2>Controlling the image pulling behavior<a class="headerlink" href="#controlling-the-image-pulling-behavior" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">pytest_container</span></code> will by default pull all container images from the defined
registry before launching containers for tests. This is to ensure that stale
images are not used by accident. The downside is, that tests take longer to
execute, as the container runtime will try to pull images before every test.</p>
<p>This behavior can be configured via the environment variable
<code class="docutils literal notranslate"><span class="pre">PULL_ALWAYS</span></code>. Setting it to <code class="docutils literal notranslate"><span class="pre">0</span></code> results in <code class="docutils literal notranslate"><span class="pre">pytest_container</span></code> relying on
the image cache and only pulling images if they are not present in the local
container storage.</p>
</section>
<section id="container-runtime-version">
<h2>Container Runtime version<a class="headerlink" href="#container-runtime-version" title="Permalink to this heading">¶</a></h2>
<p>Sometimes it is necessary to implement tests differently depending on the
version of the container runtime. The subclasses of
<a class="reference internal" href="api.html#pytest_container.runtime.OciRuntimeBase" title="pytest_container.runtime.OciRuntimeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">OciRuntimeBase</span></code></a> have the property
<a class="reference internal" href="api.html#pytest_container.runtime.OciRuntimeABC.version" title="pytest_container.runtime.OciRuntimeABC.version"><code class="xref py py-attr docutils literal notranslate"><span class="pre">version</span></code></a> which returns the
runtime version of the respective runtime, e.g. of <strong class="command">podman</strong>.</p>
<p>The returned object is an instance of
<a class="reference internal" href="api.html#pytest_container.runtime.Version" title="pytest_container.runtime.Version"><code class="xref py py-class docutils literal notranslate"><span class="pre">Version</span></code></a> and supports comparison to for
instance skip certain tests:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
    <span class="n">get_selected_runtime</span><span class="p">()</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;This check requires at least Podman 4.0&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_modern_podman_feature</span><span class="p">(</span><span class="n">auto_container</span><span class="p">):</span>
    <span class="c1"># test $new_feature here</span>
</pre></div>
</div>
</section>
<section id="copying-files-into-containers">
<h2>Copying files into containers<a class="headerlink" href="#copying-files-into-containers" title="Permalink to this heading">¶</a></h2>
<p>Sometimes we need to have files available in the container image to e.g. execute
some script in an integration test. This can be achieved in two ways:</p>
<section id="copy-the-files-at-build-time">
<h3>1. Copy the files at build time<a class="headerlink" href="#copy-the-files-at-build-time" title="Permalink to this heading">¶</a></h3>
<p>You can include the desired files by creating a
<a class="reference internal" href="api.html#pytest_container.container.DerivedContainer" title="pytest_container.container.DerivedContainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">DerivedContainer</span></code></a> and insert the file
using the <code class="docutils literal notranslate"><span class="pre">COPY</span></code> or <code class="docutils literal notranslate"><span class="pre">ADD</span></code> instruction in the <code class="file docutils literal notranslate"><span class="pre">Dockerfile</span></code> (<code class="docutils literal notranslate"><span class="pre">COPY</span></code> is
the recommended default nowadays, for a comparison of both instructions please
refer to e.g. <a class="reference external" href="https://phoenixnap.com/kb/docker-add-vs-copy">https://phoenixnap.com/kb/docker-add-vs-copy</a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DIR</span> <span class="o">=</span> <span class="s2">&quot;path/to/testfile&quot;</span>
<span class="n">FILE</span> <span class="o">=</span> <span class="s2">&quot;test.py&quot;</span>
<span class="n">CDIR</span> <span class="o">=</span> <span class="s2">&quot;/dir/in/container&quot;</span>
<span class="n">DOCKERFILE</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">...</span>
<span class="s2">COPY </span><span class="si">{</span><span class="n">DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">FILE</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">CDIR</span><span class="si">}</span>
<span class="s2">...</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">CONTAINER1</span> <span class="o">=</span> <span class="n">DerivedContainer</span><span class="p">(</span>
  <span class="n">base</span><span class="o">=</span><span class="n">some_base_image</span><span class="p">,</span>
  <span class="n">containerfile</span><span class="o">=</span><span class="n">DOCKERFILE</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The path to <code class="file docutils literal notranslate"><span class="pre">test.py</span></code> is saved in the variable <code class="docutils literal notranslate"><span class="pre">DIR</span></code> and must be
relative to the root directory from which you execute pytest.</p>
<p>The object <code class="docutils literal notranslate"><span class="pre">CONTAINER1</span></code> can now be used as any other container:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;container_per_test&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="n">CONTAINER1</span><span class="p">],</span>
    <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_my_script</span><span class="p">(</span><span class="n">container_per_test</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="n">container_per_test</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">run_expect</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;python3 </span><span class="si">{</span><span class="n">CDIR</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">FILE</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="copy-the-files-at-runtime-into-the-running-container">
<h3>2. Copy the files at runtime into the running container<a class="headerlink" href="#copy-the-files-at-runtime-into-the-running-container" title="Permalink to this heading">¶</a></h3>
<p>It is also possible to copy files into a container via <strong class="command">podman cp</strong> or
<strong class="command">docker cp</strong>. In contrast to the first method, this has the disadvantage
that the copy has to be executed for every test and it cannot be cached during
the image build. However, it allows us to dynamically create files for each
test, which is not that easily possible with the first approach.</p>
<p>To successfully copy files, we need to undertake the following steps:</p>
<ol class="arabic simple">
<li><p>Request the following fixtures: any of the <code class="docutils literal notranslate"><span class="pre">(auto)_container_per_test</span></code>,
<code class="docutils literal notranslate"><span class="pre">host</span></code>, <code class="docutils literal notranslate"><span class="pre">container_runtime</span></code>.</p></li>
<li><p>Obtain the running container’s hash.</p></li>
<li><p>Use <strong class="command">podman|docker cp command</strong>, via testinfra’s host fixture.</p></li>
</ol>
<p>The above steps could be implemented as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DIR</span> <span class="o">=</span> <span class="s2">&quot;path/to/testfile&quot;</span>
<span class="n">FILE</span> <span class="o">=</span> <span class="s2">&quot;test.py&quot;</span>
<span class="n">CDIR</span> <span class="o">=</span> <span class="s2">&quot;/dir/in/container&quot;</span>

<span class="k">def</span> <span class="nf">test_my_script</span><span class="p">(</span><span class="n">auto_container_per_test</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">container_runtime</span><span class="p">):</span>
    <span class="n">host</span><span class="o">.</span><span class="n">run_expect</span><span class="p">(</span>
      <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">container_runtime</span><span class="o">.</span><span class="n">runner_binary</span><span class="si">}</span><span class="s2"> cp </span><span class="si">{</span><span class="n">DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">FILE</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">auto_container_per_test</span><span class="o">.</span><span class="n">container_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">CDIR</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Note that the same file location restrictions apply as when including the files
in the container image directly.</p>
</section>
</section>
<section id="exposing-ports-from-containers">
<h2>Exposing ports from containers<a class="headerlink" href="#exposing-ports-from-containers" title="Permalink to this heading">¶</a></h2>
<p>Exposing ports from containers is a tricky topic when tests are run in parallel,
as one can no longer set the port on the host because it would be used by
multiple containers. To remedy this, you can add the ports that shall be exposed
to the <a class="reference internal" href="api.html#pytest_container.container.ContainerBase.forwarded_ports" title="pytest_container.container.ContainerBase.forwarded_ports"><code class="xref py py-attr docutils literal notranslate"><span class="pre">forwarded_ports</span></code></a>
attribute as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">WEB_SERVER</span> <span class="o">=</span> <span class="n">DerivedContainer</span><span class="p">(</span>
    <span class="n">containerfile</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># snip</span>
<span class="s2">EXPOSE 8000</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">forwarded_ports</span><span class="o">=</span><span class="p">[</span><span class="n">PortForwarding</span><span class="p">(</span><span class="n">container_port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)],</span>
<span class="p">)</span>
</pre></div>
</div>
<p>When such a container image is requested via any of the <code class="docutils literal notranslate"><span class="pre">container_*</span></code>
fixtures, then the resulting data passed into the test function will have the
attribute <code class="docutils literal notranslate"><span class="pre">forwarded_ports</span></code> set as well. This is a list of
<a class="reference internal" href="api.html#pytest_container.inspect.PortForwarding" title="pytest_container.inspect.PortForwarding"><code class="xref py py-class docutils literal notranslate"><span class="pre">PortForwarding</span></code></a> instances that have the
property <a class="reference internal" href="api.html#pytest_container.inspect.PortForwarding.host_port" title="pytest_container.inspect.PortForwarding.host_port"><code class="xref py py-attr docutils literal notranslate"><span class="pre">host_port</span></code></a> set to
the port that <code class="docutils literal notranslate"><span class="pre">pytest_container</span></code> used to expose the container’s port:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_port_forward_set_up</span><span class="p">(</span><span class="n">auto_container</span><span class="p">:</span> <span class="n">ContainerData</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">run_expect</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="sa">f</span><span class="s2">&quot;curl localhost:</span><span class="si">{</span><span class="n">auto_container</span><span class="o">.</span><span class="n">forwarded_ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">host_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="setting-up-bind-mounts-or-container-volumes">
<h2>Setting up bind mounts or container volumes<a class="headerlink" href="#setting-up-bind-mounts-or-container-volumes" title="Permalink to this heading">¶</a></h2>
<p>Some tests require that containers are launched with a bind mount or a container
volume attached to the container. While this can be achieved by adding the
respective mount command line arguments to
<a class="reference internal" href="api.html#pytest_container.container.ContainerBase.extra_launch_args" title="pytest_container.container.ContainerBase.extra_launch_args"><code class="xref py py-attr docutils literal notranslate"><span class="pre">extra_launch_args</span></code></a>, this
approach can quickly cause problems for concurrent tests (multiple containers
could be accessing the a volume at the same time) and poses challenges to
correctly clean up after the test runs and not leave stray volumes on the test
runner.</p>
<p><code class="docutils literal notranslate"><span class="pre">pytest_container</span></code> offers a convenience class for creating bind mounts and
container volumes via <a class="reference internal" href="api.html#pytest_container.container.BindMount" title="pytest_container.container.BindMount"><code class="xref py py-class docutils literal notranslate"><span class="pre">BindMount</span></code></a> and
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolume" title="pytest_container.container.ContainerVolume"><code class="xref py py-class docutils literal notranslate"><span class="pre">ContainerVolume</span></code></a>, respectively. Instances
of either of these two classes can be added to the list
<a class="reference internal" href="api.html#pytest_container.container.ContainerBase.volume_mounts" title="pytest_container.container.ContainerBase.volume_mounts"><code class="xref py py-attr docutils literal notranslate"><span class="pre">volume_mounts</span></code></a> and will be
automatically configured and mounted into the respective container. The volumes
will also be cleaned up after the test run.</p>
<p><a class="reference external" href="https://docs.docker.com/storage/volumes/">Container volumes</a> are created
using the <a class="reference internal" href="api.html#pytest_container.container.ContainerVolume" title="pytest_container.container.ContainerVolume"><code class="xref py py-class docutils literal notranslate"><span class="pre">ContainerVolume</span></code></a> class. For the
most basic use case, provide a mount point in the container as a parameter to
the class. The <code class="docutils literal notranslate"><span class="pre">*container*</span></code> fixtures will then create a volume for you and
remove it after the test finishes. Additionally, they set the attribute
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolume.volume_id" title="pytest_container.container.ContainerVolume.volume_id"><code class="xref py py-attr docutils literal notranslate"><span class="pre">volume_id</span></code></a> to the id of
the newly created volume. You can also add mount flags to the volume via
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolumeBase.flags" title="pytest_container.container.ContainerVolumeBase.flags"><code class="xref py py-attr docutils literal notranslate"><span class="pre">flags</span></code></a> and specify
whether the volume can be shared between containers or not via
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolumeBase.shared" title="pytest_container.container.ContainerVolumeBase.shared"><code class="xref py py-attr docutils literal notranslate"><span class="pre">shared</span></code></a>. Note that the
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolumeBase.shared" title="pytest_container.container.ContainerVolumeBase.shared"><code class="xref py py-attr docutils literal notranslate"><span class="pre">shared</span></code></a> attribute only
affects whether the SELinux mount flag <code class="docutils literal notranslate"><span class="pre">Z</span></code> or <code class="docutils literal notranslate"><span class="pre">z</span></code> will be used. It will not
result in the same volume being available to multiple containers.</p>
<p><a class="reference external" href="https://docs.docker.com/storage/bind-mounts/">Bind mounts</a> are setup using
<a class="reference internal" href="api.html#pytest_container.container.BindMount" title="pytest_container.container.BindMount"><code class="xref py py-class docutils literal notranslate"><span class="pre">BindMount</span></code></a>. The user can either specify
the <a class="reference internal" href="api.html#pytest_container.container.BindMount.host_path" title="pytest_container.container.BindMount.host_path"><code class="xref py py-attr docutils literal notranslate"><span class="pre">host_path</span></code></a> themselves with
the caveat that the directory must be created manually beforehand and your tests
must be able to handle concurrency (if using <a class="reference external" href="https://github.com/pytest-dev/pytest-xdist">pytest-xdist</a>). You can also omit the
<a class="reference internal" href="api.html#pytest_container.container.BindMount.host_path" title="pytest_container.container.BindMount.host_path"><code class="xref py py-attr docutils literal notranslate"><span class="pre">host_path</span></code></a> attribute, in case an
ephemeral directory is sufficient. Then the <code class="docutils literal notranslate"><span class="pre">*container*</span></code> fixtures will create
a unique temporary directory before the test and clean it up afterwards. The
path to the temporary director is accessible via the
<a class="reference internal" href="api.html#pytest_container.container.BindMount.host_path" title="pytest_container.container.BindMount.host_path"><code class="xref py py-attr docutils literal notranslate"><span class="pre">host_path</span></code></a> attribute during the
test. Flags can be added similarly to container volumes via
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolumeBase.flags" title="pytest_container.container.ContainerVolumeBase.flags"><code class="xref py py-attr docutils literal notranslate"><span class="pre">flags</span></code></a> as well as
configuring sharing via
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolumeBase.shared" title="pytest_container.container.ContainerVolumeBase.shared"><code class="xref py py-attr docutils literal notranslate"><span class="pre">shared</span></code></a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you are using a bind mount with an existing directory on the host and want
to run tests in parallel, then you <strong>must</strong> set the attribute
<a class="reference internal" href="api.html#pytest_container.container.ContainerVolumeBase.shared" title="pytest_container.container.ContainerVolumeBase.shared"><code class="xref py py-attr docutils literal notranslate"><span class="pre">shared</span></code></a> to
<code class="docutils literal notranslate"><span class="pre">True</span></code>. Otherwise the directory will be relabeled to permit mounting from a
single container only and will cause SELinux errors when two containers try
to mount it at the same time.</p>
</div>
<p>The following snippet illustrates the usage of container volumes and bind
mounts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NGINX</span> <span class="o">=</span> <span class="n">DerivedContainer</span><span class="p">(</span>
    <span class="n">base</span><span class="o">=</span><span class="s2">&quot;docker.io/library/nginx&quot;</span><span class="p">,</span>
    <span class="n">containerfile</span><span class="o">=</span><span class="s2">&quot;&quot;&quot; # snip</span>
<span class="s2">    EXPOSE 80</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">volume_mounts</span><span class="o">=</span><span class="p">[</span>
        <span class="n">BindMount</span><span class="p">(</span>
            <span class="s2">&quot;/etc/nginx/templates&quot;</span><span class="p">,</span>
            <span class="n">host_path</span><span class="o">=</span><span class="s2">&quot;/path/to/templates&quot;</span>
        <span class="p">),</span>
        <span class="n">BindMount</span><span class="p">(</span>
            <span class="s2">&quot;/etc/nginx/nginx.conf&quot;</span><span class="p">,</span>
            <span class="n">host_path</span><span class="o">=</span><span class="s2">&quot;/path/to/nginx.conf&quot;</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="n">VolumeFlag</span><span class="o">.</span><span class="n">READ_ONLY</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">ContainerVolume</span><span class="p">(</span><span class="s2">&quot;/var/log/&quot;</span><span class="p">),</span>
        <span class="n">BindMount</span><span class="p">(</span><span class="s2">&quot;/var/cache/nginx&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;container_per_test&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">NGINX</span><span class="p">],</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_nginx_cache</span><span class="p">(</span><span class="n">container_per_test</span><span class="p">:</span> <span class="n">ContainerData</span><span class="p">):</span>
    <span class="n">cache_on_host</span> <span class="o">=</span> <span class="n">container_per_test</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volume_mounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">host_path</span>
    <span class="c1"># cache_on_host is a temporary directory that was just created</span>

    <span class="c1"># var_log is a ContainerVolume and received a unique volume id</span>
    <span class="c1"># it will be destroyed once the test finishes</span>
    <span class="n">var_log</span> <span class="o">=</span> <span class="n">container_per_test</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">volume_mounts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">var_log</span><span class="o">.</span><span class="n">volume_id</span>
</pre></div>
</div>
</section>
<section id="create-and-manage-pods">
<h2>Create and manage pods<a class="headerlink" href="#create-and-manage-pods" title="Permalink to this heading">¶</a></h2>
<p>Podman supports the creation of pods, a collection of containers that share the
same network and port forwards. <code class="docutils literal notranslate"><span class="pre">pytest_container</span></code> can automatically create
pods, launch all containers in the pod and remove the pod after the test via the
<a class="reference internal" href="api.html#pytest_container.plugin.pod" title="pytest_container.plugin.pod"><code class="xref py py-func docutils literal notranslate"><span class="pre">pod()</span></code></a> and
<a class="reference internal" href="api.html#pytest_container.plugin.pod_per_test" title="pytest_container.plugin.pod_per_test"><code class="xref py py-func docutils literal notranslate"><span class="pre">pod_per_test()</span></code></a> fixtures. Both fixtures require
to be parametrized with an instance of <a class="reference internal" href="api.html#pytest_container.pod.Pod" title="pytest_container.pod.Pod"><code class="xref py py-class docutils literal notranslate"><span class="pre">Pod</span></code></a> as
follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NGINX_PROXY</span> <span class="o">=</span> <span class="n">DerivedContainer</span><span class="p">(</span>
    <span class="n">base</span><span class="o">=</span><span class="s2">&quot;docker.io/library/nginx&quot;</span><span class="p">,</span>
    <span class="n">containerfile</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;RUN echo &#39;server { \n\</span>
<span class="s2">    listen 80; \n\</span>
<span class="s2">    server_name  localhost; \n\</span>
<span class="s2">    location / { \n\</span>
<span class="s2">        proxy_pass http://localhost:8000/; \n\</span>
<span class="s2">    } \n\</span>
<span class="s2">}&#39; &gt; /etc/nginx/conf.d/default.conf</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">WEB_SERVER</span> <span class="o">=</span> <span class="n">DerivedContainer</span><span class="p">(</span>
    <span class="n">base</span><span class="o">=</span><span class="s2">&quot;registry.opensuse.org/opensuse/tumbleweed&quot;</span><span class="p">,</span>
    <span class="n">containerfile</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">RUN zypper -n in python3 &amp;&amp; echo &quot;Hello Green World!&quot; &gt; index.html</span>
<span class="s2">ENTRYPOINT [&quot;/usr/bin/python3&quot;, &quot;-m&quot;, &quot;http.server&quot;]</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">PROXY_POD</span> <span class="o">=</span> <span class="n">Pod</span><span class="p">(</span>
    <span class="n">containers</span><span class="o">=</span><span class="p">[</span><span class="n">WEB_SERVER</span><span class="p">,</span> <span class="n">NGINX_PROXY</span><span class="p">],</span>
    <span class="n">port_forwardings</span><span class="o">=</span><span class="p">[</span><span class="n">PortForwarding</span><span class="p">(</span><span class="n">container_port</span><span class="o">=</span><span class="mi">80</span><span class="p">)],</span>
<span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;pod_per_test&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">PROXY_POD</span><span class="p">],</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_proxy_pod</span><span class="p">(</span><span class="n">pod_per_test</span><span class="p">:</span> <span class="n">PodData</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">pod_per_test</span><span class="o">.</span><span class="n">pod_id</span>

    <span class="n">port_80_on_host</span> <span class="o">=</span> <span class="n">pod_per_test</span><span class="o">.</span><span class="n">forwarded_ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">host_port</span>
</pre></div>
</div>
</section>
<section id="entrypoint-launch-command-and-stop-signal-handling">
<h2>Entrypoint, launch command and stop signal handling<a class="headerlink" href="#entrypoint-launch-command-and-stop-signal-handling" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">pytest_container</span></code> will by default (when
<a class="reference internal" href="api.html#pytest_container.container.ContainerBase.entry_point" title="pytest_container.container.ContainerBase.entry_point"><code class="xref py py-attr docutils literal notranslate"><span class="pre">entry_point</span></code></a> is set to
<a class="reference internal" href="api.html#pytest_container.container.EntrypointSelection.AUTO" title="pytest_container.container.EntrypointSelection.AUTO"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AUTO</span></code></a>) try to
automatically pick the correct entrypoint for your container:</p>
<ol class="arabic simple">
<li><p>If <a class="reference internal" href="api.html#pytest_container.container.ContainerBase.custom_entry_point" title="pytest_container.container.ContainerBase.custom_entry_point"><code class="xref py py-attr docutils literal notranslate"><span class="pre">custom_entry_point</span></code></a> is
set, then that binary will be used.</p></li>
<li><p>If the container image defines a <code class="docutils literal notranslate"><span class="pre">CMD</span></code> or an <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code>, then it will
be launched without specifying an entrypoint.</p></li>
<li><p>Use <code class="file docutils literal notranslate"><span class="pre">/bin/bash</span></code> otherwise.</p></li>
</ol>
<p>This behavior can be customized via the attribute
<a class="reference internal" href="api.html#pytest_container.container.ContainerBase.entry_point" title="pytest_container.container.ContainerBase.entry_point"><code class="xref py py-attr docutils literal notranslate"><span class="pre">entry_point</span></code></a> to either force
the entrypoint to <code class="file docutils literal notranslate"><span class="pre">/bin/bash</span></code>
(<a class="reference internal" href="api.html#pytest_container.container.EntrypointSelection.BASH" title="pytest_container.container.EntrypointSelection.BASH"><code class="xref py py-attr docutils literal notranslate"><span class="pre">BASH</span></code></a>) or launch the
image without specifying one
(<a class="reference internal" href="api.html#pytest_container.container.EntrypointSelection.IMAGE" title="pytest_container.container.EntrypointSelection.IMAGE"><code class="xref py py-attr docutils literal notranslate"><span class="pre">IMAGE</span></code></a>).</p>
<p>The container under test is launched by default with no further
arguments. Additional arguments can be passed to the entrypoint via the
parameter
<a class="reference internal" href="api.html#pytest_container.container.ContainerBase.extra_entrypoint_args" title="pytest_container.container.ContainerBase.extra_entrypoint_args"><code class="xref py py-attr docutils literal notranslate"><span class="pre">extra_entrypoint_args</span></code></a>. The
list of arguments/parameters is appended to the container launch command line
after the container image.</p>
<p>Changing the container entrypoint can have a catch with respect to the
<code class="docutils literal notranslate"><span class="pre">STOPSIGNAL</span></code> defined by a container image. Container images that have
non-shell entry points sometimes use a different signal for stopping the main
process. However, a shell might not react to such a signal at all. This is not a
problem, as the container runtime will eventually resort to sending <code class="docutils literal notranslate"><span class="pre">SIGKILL</span></code>
to the container if it does not stop. But it slows the tests needlessly down, as
the container runtime waits for 10 seconds before sending
<code class="docutils literal notranslate"><span class="pre">SIGKILL</span></code>. Therefore, <code class="docutils literal notranslate"><span class="pre">pytest_container</span></code> sets the stop signal to
<code class="docutils literal notranslate"><span class="pre">SIGTERM</span></code>, if used <code class="file docutils literal notranslate"><span class="pre">/bin/bash</span></code> as the entrypoint.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pytest_container</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="fixtures.html">Fixtures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage Tips</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adding-global-build-run-or-pod-create-arguments">Adding global build, run or pod create arguments</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-logging">Configuring logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-local-images">Testing local images</a></li>
<li class="toctree-l2"><a class="reference internal" href="#controlling-the-image-pulling-behavior">Controlling the image pulling behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="#container-runtime-version">Container Runtime version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#copying-files-into-containers">Copying files into containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exposing-ports-from-containers">Exposing ports from containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-bind-mounts-or-container-volumes">Setting up bind mounts or container volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-and-manage-pods">Create and manage pods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#entrypoint-launch-command-and-stop-signal-handling">Entrypoint, launch command and stop signal handling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="fixtures.html" title="previous chapter">Fixtures</a></li>
      <li>Next: <a href="changelog.html" title="next chapter">Changelog</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Dan Čermák.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/usage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>